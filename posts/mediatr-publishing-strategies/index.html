<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Extending MediatR with publishing strategies" /><meta property="og:locale" content="en" /><meta name="description" content="Explore advanced publishing strategies with the MediatR library in .NET applications. This article describes how to extend the MediatR library to support custom strategies while publishing notifications. Learn how to implement, register, and use these strategies with ease in your .NET projects." /><meta property="og:description" content="Explore advanced publishing strategies with the MediatR library in .NET applications. This article describes how to extend the MediatR library to support custom strategies while publishing notifications. Learn how to implement, register, and use these strategies with ease in your .NET projects." /><link rel="canonical" href="https://fiseni.com/posts/mediatr-publishing-strategies/" /><meta property="og:url" content="https://fiseni.com/posts/mediatr-publishing-strategies/" /><meta property="og:site_name" content="Fati Iseni - Blog" /><meta property="og:image" content="https://fiseni.com/assets/img/posts/777456/cover.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-05-30T13:00:00+02:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://fiseni.com/assets/img/posts/777456/cover.png" /><meta property="twitter:title" content="Extending MediatR with publishing strategies" /><meta name="twitter:site" content="@fiseni" /><meta name="google-site-verification" content="p9Rvv10SRN6FJ9f7Vbg7Pnrts_Y9_nDh4zVdFcfx7Ls" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-05-30T13:00:00+02:00","datePublished":"2024-05-30T13:00:00+02:00","description":"Explore advanced publishing strategies with the MediatR library in .NET applications. This article describes how to extend the MediatR library to support custom strategies while publishing notifications. Learn how to implement, register, and use these strategies with ease in your .NET projects.","headline":"Extending MediatR with publishing strategies","image":"https://fiseni.com/assets/img/posts/777456/cover.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://fiseni.com/posts/mediatr-publishing-strategies/"},"url":"https://fiseni.com/posts/mediatr-publishing-strategies/"}</script><title>Extending MediatR with publishing strategies | Fati Iseni - Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Fati Iseni - Blog"><meta name="application-name" content="Fati Iseni - Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.29.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { let self = this;this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { self.clearMode(); } self.notify(); }); if (!this.hasMode) { return; } if (this.isDarkMode) { this.setDark(); } else { this.setLight(); } } get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isPreferDark() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }get modeStatus() { if (this.hasMode) { return this.mode; } else { return this.isPreferDark ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); }notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { this.clearMode(); } else { if (this.isPreferDark) { this.setLight(); } else { this.setDark(); } } this.notify(); } } const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/fati-iseni.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">Fati Iseni - Blog</a></h1><p class="site-subtitle fst-italic mb-0">Software Architect</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/fiseni" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/fiseni" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['fati.iseni','pozitrongroup.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Extending MediatR with publishing strategies</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>Extending MediatR with publishing strategies</h1><div class="post-meta text-muted"><div class="mt-3 mb-3"> <a href="/assets/img/posts/777456/cover.png" class="popup img-link preview-img shimmer"><img src="/assets/img/posts/777456/cover.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"><div> <span> Posted <time data-ts="1717066800" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 30, 2024 </time> </span></div><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1600 words" > <em>8 min</em> read</span></div></div></div></header><div class="content"><p><strong> Update: I published a NuGet package that extends MediatR with these features. You can find it <a href="https://github.com/fiseni/Pozitron.Extensions.MediatR">here</a>.</strong></p><p>A few years ago I published an <a href="https://fiseni.com/posts/publishing-strategies-in-MediatR/">article</a> on how to utilize different publishing strategies for MediatR notifications. However, the authors introduced breaking changes in the API and the internals since then, so the approaches described in that article won’t work for versions 12 and onward.</p><p>Starting with version 12, we can provide a custom <code class="language-plaintext highlighter-rouge">INotificationPublisher</code> implementation during the registration.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">services</span><span class="p">.</span><span class="nf">AddMediatR</span><span class="p">(</span><span class="n">cfg</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="n">cfg</span><span class="p">.</span><span class="n">RegisterServicesFromAssemblyContaining</span><span class="p">&lt;</span><span class="n">Program</span><span class="p">&gt;();</span>
    <span class="n">cfg</span><span class="p">.</span><span class="n">NotificationPublisher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MyCustomPublisher</span><span class="p">();</span> <span class="c1">// this will be singleton</span>
    <span class="n">cfg</span><span class="p">.</span><span class="n">NotificationPublisherType</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">MyCustomPublisher</span><span class="p">);</span> <span class="c1">// this will be the ServiceLifetime</span>
<span class="p">});</span>
</pre></table></code></div></div><p>This new capability offers some flexibility, but it’s still not exactly what we want. Depending on various circumstances, we may want to publish different notifications using different strategies or even different strategies for the same notification. So, let’s define our requirements.</p><ul><li>Implement multiple publishing strategies<li>We should be able to choose a strategy while publishing a notification.<li>Ideally, the feature should be an extension to <code class="language-plaintext highlighter-rouge">IPublisher</code>. Consumers should not have to deal with new types.</ul><h2 id="publishing-strategies"><span class="me-2">Publishing Strategies</span><a href="#publishing-strategies" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Let’s first create an enum with the strategies we plan on supporting.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">enum</span> <span class="n">PublishStrategy</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// The default publisher or the one set in MediatR configuration.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">Default</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Executes and awaits each notification handler after one another.</span>
    <span class="c1">/// Returns when all handlers complete or an exception has been thrown.</span>
    <span class="c1">/// In case of an exception, the rest of the handlers are not executed.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">Sequential</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Executes and awaits each notification handler after one another.</span>
    <span class="c1">/// Returns when all handlers complete. It continues on exception(s).</span>
    <span class="c1">/// In case of any exception(s), they will be captured in an AggregateException.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">SequentialAll</span> <span class="p">=</span> <span class="m">2</span><span class="p">,</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="extending-mediator"><span class="me-2">Extending Mediator</span><a href="#extending-mediator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Next, let’s define the <code class="language-plaintext highlighter-rouge">INotificationPublisher</code> implementations. You may notice that <code class="language-plaintext highlighter-rouge">SequentialPublisher</code> is the same as the built-in one. I picked them just as an example to demonstrate how to hook them up. You’ll define your desired custom publishers.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">SequentialPublisher</span> <span class="p">:</span> <span class="n">INotificationPublisher</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Publish</span><span class="p">(</span>
        <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">NotificationHandlerExecutor</span><span class="p">&gt;</span> <span class="n">handlerExecutors</span><span class="p">,</span>
        <span class="n">INotification</span> <span class="n">notification</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">handler</span> <span class="k">in</span> <span class="n">handlerExecutors</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">handler</span><span class="p">.</span><span class="nf">HandlerCallback</span><span class="p">(</span><span class="n">notification</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">SequentialAllPublisher</span> <span class="p">:</span> <span class="n">INotificationPublisher</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Publish</span><span class="p">(</span>
        <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">NotificationHandlerExecutor</span><span class="p">&gt;</span> <span class="n">handlerExecutors</span><span class="p">,</span>
        <span class="n">INotification</span> <span class="n">notification</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">List</span><span class="p">&lt;</span><span class="n">Exception</span><span class="p">&gt;?</span> <span class="n">exceptions</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">handlerExecutor</span> <span class="k">in</span> <span class="n">handlerExecutors</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">await</span> <span class="n">handlerExecutor</span><span class="p">.</span><span class="nf">HandlerCallback</span><span class="p">(</span><span class="n">notification</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">AggregateException</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="p">(</span><span class="n">exceptions</span> <span class="p">??=</span> <span class="p">[]).</span><span class="nf">AddRange</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="nf">Flatten</span><span class="p">().</span><span class="n">InnerExceptions</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="p">(</span><span class="n">exceptions</span> <span class="p">??=</span> <span class="p">[]).</span><span class="nf">Add</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">exceptions</span><span class="p">?.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">AggregateException</span><span class="p">(</span><span class="n">exceptions</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The Mediator implementation expects this publisher implementation to be provided in the constructor, along with the <code class="language-plaintext highlighter-rouge">IServiceProvider</code>. So, we can not just do this, and call it a day.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="n">Task</span> <span class="n">Publish</span><span class="p">&lt;</span><span class="n">TNotification</span><span class="p">&gt;(</span>
    <span class="k">this</span> <span class="n">IPublisher</span> <span class="n">publisher</span><span class="p">,</span>
    <span class="n">TNotification</span> <span class="n">notification</span><span class="p">,</span>
    <span class="n">PublishStrategy</span> <span class="n">strategy</span><span class="p">,</span>
    <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
    <span class="k">where</span> <span class="n">TNotification</span> <span class="p">:</span> <span class="n">INotification</span>
<span class="p">{</span>
    <span class="n">INotificationPublisher</span><span class="p">?</span> <span class="n">notificationPublisher</span> <span class="p">=</span> <span class="n">strategy</span> <span class="k">switch</span>
    <span class="p">{</span>
        <span class="n">PublishStrategy</span><span class="p">.</span><span class="n">Sequential</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">SequentialPublisher</span><span class="p">(),</span>
        <span class="n">PublishStrategy</span><span class="p">.</span><span class="n">SequentialAll</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">SequentialAllPublisher</span><span class="p">(),</span>
        <span class="n">_</span> <span class="p">=&gt;</span> <span class="k">null</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="n">notificationPublisher</span> <span class="k">is</span> <span class="k">null</span>
        <span class="p">?</span> <span class="n">publisher</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">notification</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">)</span>
        <span class="c1">// We need to provide the IServiceProvider</span>
        <span class="p">:</span> <span class="k">new</span> <span class="nf">Mediator</span><span class="p">(..,</span> <span class="n">notificationPublisher</span><span class="p">).</span><span class="nf">Publish</span><span class="p">(</span><span class="n">notification</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Instead, we must create our custom mediator implementation, register it during registration, and define the necessary extensions. The <code class="language-plaintext highlighter-rouge">ExtendedMediator</code> inherits <code class="language-plaintext highlighter-rouge">Mediator</code> and defines an additional <code class="language-plaintext highlighter-rouge">Publish</code> method that accepts the strategy as a parameter. Then, we create a new instance of Mediator and pass the chosen publisher. The Mediator implementation is a very lightweight object (contains only two references as a state), so creating a new instance is an acceptable approach. But, what if the consumer has defined a different lifetime (e.g. scoped) during configuration? That’s not an issue since we’re passing the resolved <code class="language-plaintext highlighter-rouge">IServiceProvider</code>. In the case of a scoped lifetime, the service provider itself is scoped and the behavior will be preserved.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">ExtendedMediator</span><span class="p">(</span><span class="n">IServiceProvider</span> <span class="n">serviceProvider</span><span class="p">)</span> <span class="p">:</span> <span class="nf">Mediator</span><span class="p">(</span><span class="n">serviceProvider</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceProvider</span> <span class="n">_serviceProvider</span> <span class="p">=</span> <span class="n">serviceProvider</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">PublishStrategy</span><span class="p">,</span> <span class="n">INotificationPublisher</span><span class="p">&gt;</span> <span class="n">_publishers</span> <span class="p">=</span> <span class="k">new</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">PublishStrategy</span><span class="p">.</span><span class="n">Sequential</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SequentialPublisher</span><span class="p">(),</span>
        <span class="p">[</span><span class="n">PublishStrategy</span><span class="p">.</span><span class="n">SequentialAll</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SequentialAllPublisher</span><span class="p">(),</span>
    <span class="p">};</span>

    <span class="k">public</span> <span class="n">Task</span> <span class="n">Publish</span><span class="p">&lt;</span><span class="n">TNotification</span><span class="p">&gt;(</span>
        <span class="n">TNotification</span> <span class="n">notification</span><span class="p">,</span>
        <span class="n">PublishStrategy</span> <span class="n">strategy</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TNotification</span> <span class="p">:</span> <span class="n">INotification</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_publishers</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">publisher</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="nf">Mediator</span><span class="p">(</span><span class="n">_serviceProvider</span><span class="p">,</span> <span class="n">publisher</span><span class="p">).</span><span class="nf">Publish</span><span class="p">(</span><span class="n">notification</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nf">Publish</span><span class="p">(</span><span class="n">notification</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MediatorExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">Task</span> <span class="n">Publish</span><span class="p">&lt;</span><span class="n">TNotification</span><span class="p">&gt;(</span>
        <span class="k">this</span> <span class="n">IPublisher</span> <span class="n">publisher</span><span class="p">,</span>
        <span class="n">TNotification</span> <span class="n">notification</span><span class="p">,</span>
        <span class="n">PublishStrategy</span> <span class="n">strategy</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TNotification</span> <span class="p">:</span> <span class="n">INotification</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">publisher</span> <span class="k">is</span> <span class="n">ExtendedMediator</span> <span class="n">extendedMediator</span>
            <span class="p">?</span> <span class="n">extendedMediator</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">notification</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">)</span>
            <span class="p">:</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotSupportedException</span><span class="p">(</span><span class="s">"The extended mediator implementation is not registered! Register it with the IServiceCollection.AddExtendedMediatR extensions."</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">IServiceCollection</span> <span class="nf">AddExtendedMediatR</span><span class="p">(</span>
        <span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">,</span>
        <span class="n">Action</span><span class="p">&lt;</span><span class="n">MediatRServiceConfiguration</span><span class="p">&gt;</span> <span class="n">configuration</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">serviceConfig</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MediatRServiceConfiguration</span><span class="p">();</span>
        <span class="n">configuration</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">serviceConfig</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">services</span><span class="p">.</span><span class="nf">AddExtendedMediatR</span><span class="p">(</span><span class="n">serviceConfig</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">IServiceCollection</span> <span class="nf">AddExtendedMediatR</span><span class="p">(</span>
        <span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">,</span>
        <span class="n">MediatRServiceConfiguration</span> <span class="n">configuration</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">configuration</span><span class="p">.</span><span class="n">MediatorImplementationType</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ExtendedMediator</span><span class="p">);</span>
        <span class="n">services</span><span class="p">.</span><span class="nf">AddMediatR</span><span class="p">(</span><span class="n">configuration</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">services</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="usage"><span class="me-2">Usage</span><a href="#usage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that we’re all set, the usage is quite straightforward.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddExtendedMediatR</span><span class="p">(</span><span class="n">cfg</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="c1">// All your desired configuration.</span>
    <span class="n">cfg</span><span class="p">.</span><span class="n">RegisterServicesFromAssemblyContaining</span><span class="p">&lt;</span><span class="n">Program</span><span class="p">&gt;();</span>
	
    <span class="c1">// Our extension will always set the MediatorImplementationType to ExtendedMediator.</span>
<span class="p">});</span>
</pre></table></code></div></div><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">IPublisher</span> <span class="n">publisher</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Run</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// The built-in behavior</span>
        <span class="k">await</span> <span class="n">publisher</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="k">new</span> <span class="nf">Ping</span><span class="p">(),</span> <span class="n">cancellationToken</span><span class="p">);</span>

        <span class="c1">// Publish with specific strategy</span>
        <span class="k">await</span> <span class="n">publisher</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="k">new</span> <span class="nf">Ping</span><span class="p">(),</span> <span class="n">PublishStrategy</span><span class="p">.</span><span class="n">SequentialAll</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="background-tasks"><span class="me-2">Background Tasks</span><a href="#background-tasks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There might be cases where you want to publish a notification and not wait for the handler’s completion. Simply, you want them to run as background tasks. I’d avoid this approach and use these strategies sparingly, however, you might have a valid use case. To implement this feature, we might be compelled to just add a new publisher as follows.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">enum</span> <span class="n">PublishStrategy</span>
<span class="p">{</span>
    <span class="n">Default</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
    <span class="n">Sequential</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>
    <span class="n">SequentialAll</span> <span class="p">=</span> <span class="m">2</span><span class="p">,</span>
    <span class="n">SequentialBackground</span> <span class="p">=</span> <span class="m">3</span><span class="p">,</span>
    <span class="n">SequentialAllBackground</span> <span class="p">=</span> <span class="m">4</span><span class="p">,</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">SequentialBackgroundPublisher</span> <span class="p">:</span> <span class="n">INotificationPublisher</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Task</span> <span class="nf">Publish</span><span class="p">(</span>
        <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">NotificationHandlerExecutor</span><span class="p">&gt;</span> <span class="n">handlerExecutors</span><span class="p">,</span>
        <span class="n">INotification</span> <span class="n">notification</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">handler</span> <span class="k">in</span> <span class="n">handlerExecutors</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">await</span> <span class="n">handler</span><span class="p">.</span><span class="nf">HandlerCallback</span><span class="p">(</span><span class="n">notification</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Handle as needed.</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>However, this is a bad idea. This implementation won’t behave correctly; for not so obvious reasons. If the consumer has defined a scoped lifetime, once the request is completed, the scope and all resolved dependencies out of that scope will be disposed. The background task we’ve defined may outlive the request, and our handlers will end up with disposed dependencies.</p><p>We must run the background task in a separate scope. Moreover, we can’t create a scope out of the injected <code class="language-plaintext highlighter-rouge">IServiceProvider</code> since the provider itself is scoped. Instead, we need a separate scope out of the root provider. That said, the updated implementation would be as follows.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre><td class="rouge-code"><pre><span class="k">internal</span> <span class="k">class</span> <span class="nc">ExtendedMediator</span><span class="p">(</span>
    <span class="n">IServiceScopeFactory</span> <span class="n">serviceScopeFactory</span><span class="p">,</span>
    <span class="n">IServiceProvider</span> <span class="n">serviceProvider</span><span class="p">)</span>
    <span class="p">:</span> <span class="nf">Mediator</span><span class="p">(</span><span class="n">serviceProvider</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceScopeFactory</span> <span class="n">_serviceScopeFactory</span> <span class="p">=</span> <span class="n">serviceScopeFactory</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceProvider</span> <span class="n">_serviceProvider</span> <span class="p">=</span> <span class="n">serviceProvider</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">PublishStrategy</span><span class="p">,</span> <span class="p">(</span><span class="n">INotificationPublisher</span> <span class="n">Publisher</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsBackgroundTask</span><span class="p">)&gt;</span> <span class="n">_publishers</span> <span class="p">=</span> <span class="k">new</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">PublishStrategy</span><span class="p">.</span><span class="n">Sequential</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="nf">SequentialPublisher</span><span class="p">(),</span> <span class="k">false</span><span class="p">),</span>
        <span class="p">[</span><span class="n">PublishStrategy</span><span class="p">.</span><span class="n">SequentialAll</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="nf">SequentialAllPublisher</span><span class="p">(),</span> <span class="k">false</span><span class="p">),</span>
        <span class="p">[</span><span class="n">PublishStrategy</span><span class="p">.</span><span class="n">SequentialBackground</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="nf">SequentialPublisher</span><span class="p">(),</span> <span class="k">true</span><span class="p">),</span>
        <span class="p">[</span><span class="n">PublishStrategy</span><span class="p">.</span><span class="n">SequentialAllBackground</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="nf">SequentialAllPublisher</span><span class="p">(),</span> <span class="k">true</span><span class="p">),</span>
    <span class="p">};</span>

    <span class="k">public</span> <span class="n">Task</span> <span class="n">Publish</span><span class="p">&lt;</span><span class="n">TNotification</span><span class="p">&gt;(</span>
        <span class="n">TNotification</span> <span class="n">notification</span><span class="p">,</span>
        <span class="n">PublishStrategy</span> <span class="n">strategy</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TNotification</span> <span class="p">:</span> <span class="n">INotification</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_publishers</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="k">out</span> <span class="p">(</span><span class="n">INotificationPublisher</span> <span class="n">Publisher</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsBackgroundTask</span><span class="p">)</span> <span class="n">item</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">item</span><span class="p">.</span><span class="n">IsBackgroundTask</span>
                <span class="p">?</span> <span class="nf">PublishBackground</span><span class="p">(</span><span class="n">_serviceScopeFactory</span><span class="p">,</span> <span class="n">notification</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">Publisher</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">)</span>
                <span class="p">:</span> <span class="nf">Publish</span><span class="p">(</span><span class="n">_serviceProvider</span><span class="p">,</span> <span class="n">notification</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">Publisher</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Fall back to the default behavior</span>
        <span class="k">return</span> <span class="nf">Publish</span><span class="p">(</span><span class="n">notification</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="n">Task</span> <span class="n">Publish</span><span class="p">&lt;</span><span class="n">TNotification</span><span class="p">&gt;(</span>
        <span class="n">IServiceProvider</span> <span class="n">serviceProvider</span><span class="p">,</span>
        <span class="n">TNotification</span> <span class="n">notification</span><span class="p">,</span>
        <span class="n">INotificationPublisher</span> <span class="n">publisher</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span> <span class="k">where</span> <span class="n">TNotification</span> <span class="p">:</span> <span class="n">INotification</span>
        <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">Mediator</span><span class="p">(</span><span class="n">serviceProvider</span><span class="p">,</span> <span class="n">publisher</span><span class="p">).</span><span class="nf">Publish</span><span class="p">(</span><span class="n">notification</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>

    <span class="k">private</span> <span class="k">static</span> <span class="n">Task</span> <span class="n">PublishBackground</span><span class="p">&lt;</span><span class="n">TNotification</span><span class="p">&gt;(</span>
        <span class="n">IServiceScopeFactory</span> <span class="n">serviceScopeFactory</span><span class="p">,</span>
        <span class="n">TNotification</span> <span class="n">notification</span><span class="p">,</span>
        <span class="n">INotificationPublisher</span> <span class="n">publisher</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span> <span class="k">where</span> <span class="n">TNotification</span> <span class="p">:</span> <span class="n">INotification</span>
    <span class="p">{</span>
        <span class="n">_</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">using</span> <span class="nn">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">serviceScopeFactory</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">();</span>
            <span class="kt">var</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">ILogger</span><span class="p">&lt;</span><span class="n">ExtendedMediator</span><span class="p">&gt;&gt;();</span>

            <span class="k">try</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">mediator</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Mediator</span><span class="p">(</span><span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">,</span> <span class="n">publisher</span><span class="p">);</span>
                <span class="k">await</span> <span class="n">mediator</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">notification</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// The aggregate exceptions are already flattened by the publishers.</span>
                <span class="n">logger</span><span class="p">?.</span><span class="nf">LogError</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">"Error occurred while executing the handler(s) in a background thread!"</span><span class="p">);</span>
            <span class="p">}</span>

        <span class="p">},</span> <span class="n">cancellationToken</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This implementation also offers the ability to wrap any publisher in a background task. So, instead of having separate Background enum items, you may define an additional <code class="language-plaintext highlighter-rouge">runAsBackgroundTask</code> parameter for the <code class="language-plaintext highlighter-rouge">Publish</code> method. That’s up to you to decide which API is more convenient for you.</p><p>I hope you found this article useful. Happy coding!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/tutorial/">Tutorial</a>, <a href="/categories/software-development/">Software Development</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/mediator/" class="post-tag no-text-decoration" >Mediator</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Extending%20MediatR%20with%20publishing%20strategies%20-%20Fati%20Iseni%20-%20Blog&url=https%3A%2F%2Ffiseni.com%2Fposts%2Fmediatr-publishing-strategies%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Extending%20MediatR%20with%20publishing%20strategies%20-%20Fati%20Iseni%20-%20Blog&u=https%3A%2F%2Ffiseni.com%2Fposts%2Fmediatr-publishing-strategies%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ffiseni.com%2Fposts%2Fmediatr-publishing-strategies%2F&text=Extending%20MediatR%20with%20publishing%20strategies%20-%20Fati%20Iseni%20-%20Blog" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/publishing-strategies-in-MediatR/">Publishing strategies in MediatR</a><li class="text-truncate lh-lg"> <a href="/posts/mediatr-publishing-strategies/">Extending MediatR with publishing strategies</a><li class="text-truncate lh-lg"> <a href="/posts/the-journey-to-630x-faster-batch-job/">From Hours to Seconds: The Journey to a 630x Faster Batch Job</a><li class="text-truncate lh-lg"> <a href="/posts/soft-delete/">Global soft delete in EF Core!</a><li class="text-truncate lh-lg"> <a href="/posts/current-user-aspnetcore/">Current user implementation in ASP.NET Core!</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/efcore/">EFCore</a> <a class="post-tag btn btn-outline-primary" href="/tags/design-patterns/">design patterns</a> <a class="post-tag btn btn-outline-primary" href="/tags/dotnetcore/">dotnetcore</a> <a class="post-tag btn btn-outline-primary" href="/tags/software-architecture/">software architecture</a> <a class="post-tag btn btn-outline-primary" href="/tags/ddd/">ddd</a> <a class="post-tag btn btn-outline-primary" href="/tags/dotnet/">dotnet</a> <a class="post-tag btn btn-outline-primary" href="/tags/mediator/">Mediator</a> <a class="post-tag btn btn-outline-primary" href="/tags/productivity/">Productivity</a> <a class="post-tag btn btn-outline-primary" href="/tags/auditing/">Auditing</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a></div></section></div><section id="toc-wrapper" class="d-none ps-0 pe-4"><h2 class="panel-heading ps-3 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/publishing-strategies-in-MediatR/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1671274800" data-df="ll" > Dec 17, 2022 </time><h4 class="pt-0 my-2">Publishing strategies in MediatR</h4><div class="text-muted"><p>Explore advanced publishing strategies with the MediatR library in .NET applications. This article dives into the Mediator pattern, its benefits, and how to extend the MediatR library to support cu...</p></div></div></a></article><article class="col"> <a href="/posts/simplifying-configuration-for-temporal-tables-in-EF-Core/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1673780400" data-df="ll" > Jan 15, 2023 </time><h4 class="pt-0 my-2">Simplifying Configuration for Temporal Tables in EF Core!</h4><div class="text-muted"><p>Learn how to simplify the configuration of temporal tables in EF Core.</p></div></div></a></article><article class="col"> <a href="/posts/ensuring-non-nullable-navigation-in-ef-core/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1669806000" data-df="ll" > Nov 30, 2022 </time><h4 class="pt-0 my-2">Owned Entity Types: Ensuring Non-Nullable Navigation in EF Core</h4><div class="text-muted"><p>Discover how to tackle a common misconfiguration issue in Entity Framework Core involving owned types and nullable navigations. Learn how to ensure non-nullable navigation properties with practical...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/the-journey-to-630x-faster-batch-job/" class="btn btn-outline-primary" aria-label="Older" ><p>From Hours to Seconds: The Journey to a 630x Faster Batch Job</p></a><div class="btn btn-outline-primary disabled" aria-label="Newer"><p>-</p></div></nav><div id="disqus_thread"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://fiseni.com/posts/mediatr-publishing-strategies/'; this.page.identifier = '/posts/mediatr-publishing-strategies/'; };var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://fiseni.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.getElementById('disqus_thread'));function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.getElementById('mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2024</time> <a href="https://twitter.com/fiseni">Fati Iseni</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.1.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/efcore/">EFCore</a> <a class="post-tag btn btn-outline-primary" href="/tags/design-patterns/">design patterns</a> <a class="post-tag btn btn-outline-primary" href="/tags/dotnetcore/">dotnetcore</a> <a class="post-tag btn btn-outline-primary" href="/tags/software-architecture/">software architecture</a> <a class="post-tag btn btn-outline-primary" href="/tags/ddd/">ddd</a> <a class="post-tag btn btn-outline-primary" href="/tags/dotnet/">dotnet</a> <a class="post-tag btn btn-outline-primary" href="/tags/mediator/">Mediator</a> <a class="post-tag btn btn-outline-primary" href="/tags/productivity/">Productivity</a> <a class="post-tag btn btn-outline-primary" href="/tags/auditing/">Auditing</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.29.0/dist/tocbot.min.js"></script> <script src="/assets/js/dist/post.min.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6N7H7NRJZ7"></script> <script> document.addEventListener('DOMContentLoaded', function (event) { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6N7H7NRJZ7'); }); </script> <script>SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>

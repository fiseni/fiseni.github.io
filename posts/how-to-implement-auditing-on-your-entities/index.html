<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="How to implement auditing on your entities!" /><meta property="og:locale" content="en" /><meta name="description" content="A guide on how to implement auditing for your entities using Entity Framework." /><meta property="og:description" content="A guide on how to implement auditing for your entities using Entity Framework." /><link rel="canonical" href="https://fiseni.com/posts/how-to-implement-auditing-on-your-entities/" /><meta property="og:url" content="https://fiseni.com/posts/how-to-implement-auditing-on-your-entities/" /><meta property="og:site_name" content="Fati Iseni - Blog" /><meta property="og:image" content="https://fiseni.com/assets/img/pozitron-cover.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-11-28T17:00:00+01:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://fiseni.com/assets/img/pozitron-cover.png" /><meta property="twitter:title" content="How to implement auditing on your entities!" /><meta name="twitter:site" content="@fiseni" /><meta name="google-site-verification" content="p9Rvv10SRN6FJ9f7Vbg7Pnrts_Y9_nDh4zVdFcfx7Ls" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-11-28T17:00:00+01:00","datePublished":"2020-11-28T17:00:00+01:00","description":"A guide on how to implement auditing for your entities using Entity Framework.","headline":"How to implement auditing on your entities!","image":"https://fiseni.com/assets/img/pozitron-cover.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://fiseni.com/posts/how-to-implement-auditing-on-your-entities/"},"url":"https://fiseni.com/posts/how-to-implement-auditing-on-your-entities/"}</script><title>How to implement auditing on your entities! | Fati Iseni - Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Fati Iseni - Blog"><meta name="application-name" content="Fati Iseni - Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.29.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { let self = this;this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { self.clearMode(); } self.notify(); }); if (!this.hasMode) { return; } if (this.isDarkMode) { this.setDark(); } else { this.setLight(); } } get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isPreferDark() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }get modeStatus() { if (this.hasMode) { return this.mode; } else { return this.isPreferDark ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); }notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { this.clearMode(); } else { if (this.isPreferDark) { this.setLight(); } else { this.setDark(); } } this.notify(); } } const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/fati-iseni.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">Fati Iseni - Blog</a></h1><p class="site-subtitle fst-italic mb-0">Software Architect</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/fiseni" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/fiseni" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['fati.iseni','pozitrongroup.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>How to implement auditing on your entities!</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>How to implement auditing on your entities!</h1><div class="post-meta text-muted"><div class="mt-3 mb-3"> <a href="/assets/img/pozitron-cover.png" class="popup img-link preview-img shimmer"><img src="/assets/img/pozitron-cover.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"><div> <span> Posted <time data-ts="1606579200" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Nov 28, 2020 </time> </span></div><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="619 words" > <em>3 min</em> read</span></div></div></div></header><div class="content"><p>Not rarely we require to apply some basic auditing information for our entities. Although we may configure full audit features on the Database side, sometimes it’s handy to have this information as part of your entities. Of course, we want this feature to be processed behind the scenes, automatically, and not deal with it manually. If you’re using Entity Framework (EF6, EFCore), implementation is quite straightforward.</p><h2 id="auditable-entities"><span class="me-2">Auditable Entities</span><a href="#auditable-entities" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Let’s create a base class that will hold the audit information. Once created, use it as a base class for all entities that you want to apply auditing.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">AuditableEntity</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">DateTime</span><span class="p">?</span> <span class="n">AuditCreatedTime</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">AuditCreatedByUserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">AuditCreatedByUsername</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">DateTime</span><span class="p">?</span> <span class="n">AuditModifiedTime</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">AuditModifiedByUserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">AuditModifiedByUsername</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>I like to prefix all the properties (and DB columns) with “Audit”. It helps me easily distinct these values, and I like having them grouped when shown by IntelliSense. You can have these properties named differently, and still, have specific names configured for the DB columns. Other than that, on top of <code class="language-plaintext highlighter-rouge">UserID</code> I usually tend to persist the <code class="language-plaintext highlighter-rouge">Username</code> of the user too. This way, if you want to utilize this information and display it on the UI, you won’t have to query the Identity persistence each time.</p><h2 id="user-information-provider"><span class="me-2">User information provider</span><a href="#user-information-provider" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If you’re using ASP.NET Core, you can access the authenticated user’s information through <code class="language-plaintext highlighter-rouge">HttpContextAccessor</code>. But, you may want to keep your persistence infrastructure in a separate project, in which case you won’t have direct access to this property. Let’s create a simple class that will encapsulate the current user’s information, and provide it wherever is required.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">CurrentUserProvider</span> <span class="p">:</span> <span class="n">ICurrentUserProvider</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IHttpContextAccessor</span> <span class="n">_httpContextAccessor</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">CurrentUserProvider</span><span class="p">(</span><span class="n">IHttpContextAccessor</span> <span class="n">httpContextAccessor</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_httpContextAccessor</span> <span class="p">=</span> <span class="n">httpContextAccessor</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">UserId</span> <span class="p">=&gt;</span> <span class="n">_httpContextAccessor</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">?.</span><span class="n">User</span><span class="p">?.</span><span class="nf">FindFirstValue</span><span class="p">(</span><span class="n">ClaimTypes</span><span class="p">.</span><span class="n">NameIdentifier</span><span class="p">);</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Username</span> <span class="p">=&gt;</span> <span class="n">_httpContextAccessor</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">?.</span><span class="n">User</span><span class="p">?.</span><span class="nf">FindFirstValue</span><span class="p">(</span><span class="n">ClaimTypes</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Also, you should register these services in your DI container as following</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IHttpContextAccessor</span><span class="p">,</span> <span class="n">HttpContextAccessor</span><span class="p">&gt;();</span>
<span class="n">services</span><span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">ICurrentUserProvider</span><span class="p">,</span> <span class="n">CurrentUserProvider</span><span class="p">&gt;();</span>
</pre></table></code></div></div><h2 id="implement-auditing"><span class="me-2">Implement auditing</span><a href="#implement-auditing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that we have the supporting infrastructure ready, let’s make a few modifications in the <code class="language-plaintext highlighter-rouge">DbContext</code> class.</p><p>First, modify the constructor and inject the <code class="language-plaintext highlighter-rouge">ICurrentUserProvider</code> implementation.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">private</span> <span class="k">readonly</span> <span class="n">ICurrentUserProvider</span> <span class="n">currentUserProvider</span><span class="p">;</span>

<span class="k">public</span> <span class="nf">MyDbContext</span><span class="p">(</span><span class="n">DbContextOptions</span><span class="p">&lt;</span><span class="n">MyDbContext</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">,</span>
                    <span class="n">ICurrentUserProvider</span> <span class="n">currentUserProvider</span><span class="p">)</span>
    <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="n">currentUserProvider</span> <span class="p">=</span> <span class="n">currentUserProvider</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Then, override the <code class="language-plaintext highlighter-rouge">SaveChangesAsync</code> method and add the actual implementation for the auditing.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">async</span> <span class="k">override</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">SaveChangesAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">addedEntries</span> <span class="p">=</span> <span class="n">ChangeTracker</span><span class="p">.</span><span class="n">Entries</span><span class="p">&lt;</span><span class="n">AuditableEntity</span><span class="p">&gt;().</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">IsAdded</span><span class="p">());</span>
    <span class="kt">var</span> <span class="n">modifiedEntries</span> <span class="p">=</span> <span class="n">ChangeTracker</span><span class="p">.</span><span class="n">Entries</span><span class="p">&lt;</span><span class="n">AuditableEntity</span><span class="p">&gt;().</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">IsModified</span><span class="p">());</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">addedEntries</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">entry</span><span class="p">.</span><span class="n">CurrentValues</span><span class="p">[</span><span class="k">nameof</span><span class="p">(</span><span class="n">AuditableEntity</span><span class="p">.</span><span class="n">AuditCreatedTime</span><span class="p">)]</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
        <span class="n">entry</span><span class="p">.</span><span class="n">CurrentValues</span><span class="p">[</span><span class="k">nameof</span><span class="p">(</span><span class="n">AuditableEntity</span><span class="p">.</span><span class="n">AuditCreatedByUserId</span><span class="p">)]</span> <span class="p">=</span> <span class="n">currentUserProvider</span><span class="p">?.</span><span class="n">UserId</span><span class="p">;</span>
        <span class="n">entry</span><span class="p">.</span><span class="n">CurrentValues</span><span class="p">[</span><span class="k">nameof</span><span class="p">(</span><span class="n">AuditableEntity</span><span class="p">.</span><span class="n">AuditCreatedByUsername</span><span class="p">)]</span> <span class="p">=</span> <span class="n">currentUserProvider</span><span class="p">?.</span><span class="n">Username</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">modifiedEntries</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">entry</span><span class="p">.</span><span class="n">CurrentValues</span><span class="p">[</span><span class="k">nameof</span><span class="p">(</span><span class="n">AuditableEntity</span><span class="p">.</span><span class="n">AuditModifiedTime</span><span class="p">)]</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
        <span class="n">entry</span><span class="p">.</span><span class="n">CurrentValues</span><span class="p">[</span><span class="k">nameof</span><span class="p">(</span><span class="n">AuditableEntity</span><span class="p">.</span><span class="n">AuditModifiedByUserId</span><span class="p">)]</span> <span class="p">=</span> <span class="n">currentUserProvider</span><span class="p">?.</span><span class="n">UserId</span><span class="p">;</span>
        <span class="n">entry</span><span class="p">.</span><span class="n">CurrentValues</span><span class="p">[</span><span class="k">nameof</span><span class="p">(</span><span class="n">AuditableEntity</span><span class="p">.</span><span class="n">AuditModifiedByUsername</span><span class="p">)]</span> <span class="p">=</span> <span class="n">currentUserProvider</span><span class="p">?.</span><span class="n">Username</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">await</span> <span class="k">base</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>You may notice, I’m using <code class="language-plaintext highlighter-rouge">IsAdded</code> and <code class="language-plaintext highlighter-rouge">IsModified</code> extensions, instead of directly utilizing the <code class="language-plaintext highlighter-rouge">EntityState</code> enum. This is important if your entities hold owned types (e.g. value objects). You want to consider the whole entity as modified if the owned types are added/modified.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ChangeTrackerExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsAdded</span><span class="p">(</span><span class="k">this</span> <span class="n">EntityEntry</span> <span class="n">entry</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="n">entry</span><span class="p">.</span><span class="n">State</span> <span class="p">==</span> <span class="n">EntityState</span><span class="p">.</span><span class="n">Added</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsModified</span><span class="p">(</span><span class="k">this</span> <span class="n">EntityEntry</span> <span class="n">entry</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="n">entry</span><span class="p">.</span><span class="n">State</span> <span class="p">!=</span> <span class="n">EntityState</span><span class="p">.</span><span class="n">Added</span> <span class="p">&amp;&amp;</span>
        <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">State</span> <span class="p">==</span> <span class="n">EntityState</span><span class="p">.</span><span class="n">Modified</span> <span class="p">||</span>
        <span class="n">entry</span><span class="p">.</span><span class="n">References</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">TargetEntry</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> 
                                    <span class="n">r</span><span class="p">.</span><span class="n">TargetEntry</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="nf">IsOwned</span><span class="p">()</span> <span class="p">&amp;&amp;</span> 
                                    <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">TargetEntry</span><span class="p">.</span><span class="n">State</span> <span class="p">==</span> <span class="n">EntityState</span><span class="p">.</span><span class="n">Added</span> <span class="p">||</span> <span class="n">r</span><span class="p">.</span><span class="n">TargetEntry</span><span class="p">.</span><span class="n">State</span> <span class="p">==</span> <span class="n">EntityState</span><span class="p">.</span><span class="n">Modified</span><span class="p">)));</span>
<span class="p">}</span>
</pre></table></code></div></div><p>And that’s all. On each save, the auditing information will be persisted for your chosen entities.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/software-development/">Software Development</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/efcore/" class="post-tag no-text-decoration" >EFCore</a> <a href="/tags/auditing/" class="post-tag no-text-decoration" >Auditing</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How%20to%20implement%20auditing%20on%20your%20entities!%20-%20Fati%20Iseni%20-%20Blog&url=https%3A%2F%2Ffiseni.com%2Fposts%2Fhow-to-implement-auditing-on-your-entities%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=How%20to%20implement%20auditing%20on%20your%20entities!%20-%20Fati%20Iseni%20-%20Blog&u=https%3A%2F%2Ffiseni.com%2Fposts%2Fhow-to-implement-auditing-on-your-entities%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ffiseni.com%2Fposts%2Fhow-to-implement-auditing-on-your-entities%2F&text=How%20to%20implement%20auditing%20on%20your%20entities!%20-%20Fati%20Iseni%20-%20Blog" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/publishing-strategies-in-MediatR/">Publishing strategies in MediatR</a><li class="text-truncate lh-lg"> <a href="/posts/mediatr-publishing-strategies/">Extending MediatR with publishing strategies</a><li class="text-truncate lh-lg"> <a href="/posts/the-journey-to-630x-faster-batch-job/">From Hours to Seconds: The Journey to a 630x Faster Batch Job</a><li class="text-truncate lh-lg"> <a href="/posts/soft-delete/">Global soft delete in EF Core!</a><li class="text-truncate lh-lg"> <a href="/posts/current-user-aspnetcore/">Current user implementation in ASP.NET Core!</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/efcore/">EFCore</a> <a class="post-tag btn btn-outline-primary" href="/tags/design-patterns/">design patterns</a> <a class="post-tag btn btn-outline-primary" href="/tags/dotnetcore/">dotnetcore</a> <a class="post-tag btn btn-outline-primary" href="/tags/software-architecture/">software architecture</a> <a class="post-tag btn btn-outline-primary" href="/tags/ddd/">ddd</a> <a class="post-tag btn btn-outline-primary" href="/tags/dotnet/">dotnet</a> <a class="post-tag btn btn-outline-primary" href="/tags/mediator/">Mediator</a> <a class="post-tag btn btn-outline-primary" href="/tags/productivity/">Productivity</a> <a class="post-tag btn btn-outline-primary" href="/tags/auditing/">Auditing</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a></div></section></div><section id="toc-wrapper" class="d-none ps-0 pe-4"><h2 class="panel-heading ps-3 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/customizing-column-naming-conventions-for-owned-types-in-ef-core/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1665658800" data-df="ll" > Oct 13, 2022 </time><h4 class="pt-0 my-2">Customizing Column Naming Conventions for Owned Types in EF Core</h4><div class="text-muted"><p>Learn how to customize column naming conventions for owned types in EF Core.</p></div></div></a></article><article class="col"> <a href="/posts/setting-global-table-naming-conventions-in-EF-Core/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1658314800" data-df="ll" > Jul 20, 2022 </time><h4 class="pt-0 my-2">Setting Global Table Naming Conventions in EF Core</h4><div class="text-muted"><p>Learn how to set up a custom global table naming convention in Entity Framework Core, allowing you to define default table names based on entity names and override them as needed.</p></div></div></a></article><article class="col"> <a href="/posts/immutable-entities-in-ef-core/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1615392000" data-df="ll" > Mar 10, 2021 </time><h4 class="pt-0 my-2">Immutable entities and value objects in EF Core!</h4><div class="text-muted"><p>How to implement and persist immutable entities and value object in Entity Framework Core.</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/what-is-a-domain-model/" class="btn btn-outline-primary" aria-label="Older" ><p>What is a domain model?</p></a> <a href="/posts/open-close-principle-and-runtime-di-configuration/" class="btn btn-outline-primary" aria-label="Newer" ><p>Open-Closed Principle and runtime DI configurations!</p></a></nav><div id="disqus_thread"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://fiseni.com/posts/how-to-implement-auditing-on-your-entities/'; this.page.identifier = '/posts/how-to-implement-auditing-on-your-entities/'; };var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://fiseni.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.getElementById('disqus_thread'));function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.getElementById('mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2024</time> <a href="https://twitter.com/fiseni">Fati Iseni</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.1.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/efcore/">EFCore</a> <a class="post-tag btn btn-outline-primary" href="/tags/design-patterns/">design patterns</a> <a class="post-tag btn btn-outline-primary" href="/tags/dotnetcore/">dotnetcore</a> <a class="post-tag btn btn-outline-primary" href="/tags/software-architecture/">software architecture</a> <a class="post-tag btn btn-outline-primary" href="/tags/ddd/">ddd</a> <a class="post-tag btn btn-outline-primary" href="/tags/dotnet/">dotnet</a> <a class="post-tag btn btn-outline-primary" href="/tags/mediator/">Mediator</a> <a class="post-tag btn btn-outline-primary" href="/tags/productivity/">Productivity</a> <a class="post-tag btn btn-outline-primary" href="/tags/auditing/">Auditing</a> <a class="post-tag btn btn-outline-primary" href="/tags/azure/">azure</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.29.0/dist/tocbot.min.js"></script> <script src="/assets/js/dist/post.min.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6N7H7NRJZ7"></script> <script> document.addEventListener('DOMContentLoaded', function (event) { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6N7H7NRJZ7'); }); </script> <script>SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
